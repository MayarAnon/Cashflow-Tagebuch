<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cashflow-Tagebuch</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #1a1a1a;
        color: #e0e0e0;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .balance {
        font-size: 1.8rem;
        font-weight: bold;
        margin-top: 15px;
      }

      .tabs {
        display: flex;
        background: #2d2d2d;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .tab {
        flex: 1;
        padding: 15px 20px;
        background: #2d2d2d;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #e0e0e0;
        transition: all 0.3s ease;
        border-right: 1px solid #444;
      }

      .tab:last-child {
        border-right: none;
      }

      .tab.active {
        background: #667eea;
        color: white;
      }

      .tab:hover:not(.active) {
        background: #3a3a3a;
      }

      .tab-content {
        display: none;
        background: #2d2d2d;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .tab-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-row {
        display: flex;
        gap: 15px;
        align-items: end;
      }

      .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #ccc;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #444;
        border-radius: 8px;
        font-size: 16px;
        background: #1a1a1a;
        color: #e0e0e0;
        transition: border-color 0.3s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: transform 0.2s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      button:hover {
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      }

      .transaction-list {
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #444;
        border-radius: 8px;
        margin-top: 20px;
        background: #1a1a1a;
      }

      .transaction-item {
        padding: 15px 20px;
        border-bottom: 1px solid #444;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .transaction-item:last-child {
        border-bottom: none;
      }

      .transaction-item:hover {
        background-color: #333;
      }

      .transaction-details {
        flex: 1;
      }

      .transaction-amount {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .income {
        color: #28a745;
      }

      .expense {
        color: #dc3545;
      }

      .transaction-meta {
        font-size: 0.9rem;
        color: #aaa;
        margin-top: 5px;
      }

      .goal-item {
        background: #333;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 5px solid #667eea;
      }

      .progress-bar {
        background: #444;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        background: linear-gradient(90deg, #28a745, #20c997);
        height: 100%;
        transition: width 0.3s ease;
      }

      .search-box {
        margin-bottom: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #2d2d2d;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #aaa;
        margin-top: 5px;
      }

      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
        }

        .tabs {
          flex-direction: column;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
      /* Spezifische Styles f√ºr Kategorie-Action-Buttons */
      .category-item button {
        padding: 5px 10px; /* Kleineres Padding */
        font-size: 12px; /* Kleinere Schriftgr√∂√üe */
        margin-left: 10px; /* Abstand zum Text/Nachbar-Button */
        border-radius: 5px; /* Leichter abgerundete Ecken */
        background: linear-gradient(
          135deg,
          #4a548f 0%,
          #5d4a7c 100%
        ); /* Etwas dunklerer Farbton */
        transform: none; /* Entfernt den Hover-Effekt (optional, falls nicht gew√ºnscht) */
        transition: background 0.2s ease;
      }

      .category-item button.btn-danger {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #a71d2a 100%
        ); /* Rot f√ºr L√∂schen */
      }

      .category-item button:hover {
        opacity: 0.9; /* Leichter Opacity-Effekt beim Hover */
        transform: none; /* Stellt sicher, dass kein translateY-Effekt auftritt */
      }

      /* Flexbox f√ºr Kategorie-Items f√ºr bessere Ausrichtung */
      .category-item {
        display: flex;
        justify-content: space-between; /* Elemente an den Enden des Containers */
        align-items: center; /* Vertikale Zentrierung */
        margin-bottom: 8px; /* Abstand zwischen den Kategorien */
        padding: 8px 0; /* Etwas Padding */
        border-bottom: 1px solid #3a3a3a; /* Trennlinie */
      }
      .category-item:last-child {
        border-bottom: none; /* Keine Trennlinie f√ºr das letzte Element */
      }

      .category-item span {
        flex-grow: 1; /* Der Text nimmt den verf√ºgbaren Platz ein */
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üí∞ Cashflow Tagebuch</h1>
        <div class="balance">
          Aktueller Saldo: <span id="totalBalance">0,00 ‚Ç¨</span>
        </div>
        <div class="savings">
          Gesamtersparnisse: <span id="totalSavedDisplay">0,00 ‚Ç¨</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('transactions')">
          Transaktionen
        </button>
        <button class="tab" onclick="showTab('fixedcosts')">Fixkosten</button>
        <button class="tab" onclick="showTab('goals')">Sparziele</button>
        <button class="tab" onclick="showTab('overview')">√úbersicht</button>
        <button class="tab" onclick="showTab('categories')">Kategorien</button>
        <button class="tab" onclick="showTab('accounts')">Konten</button>
      </div>

      <!-- Transaktionen Tab -->
      <div id="transactions" class="tab-content active">
        <h2>Transaktionen</h2>

        <div class="filter-section" style="margin-bottom: 20px;">
          <label for="filterAccount">Konto filtern:</label>
          <select id="filterAccount" style="padding: 8px; border-radius: 5px; border: 1px solid #444; background-color: #333; color: #e0e0e0;">
            <option value="all">Alle Konten</option>
            </select>
        </div>
        <h3>Neue Transaktion</h3>
        <form id="transactionForm" style="margin-bottom: 30px;">
          <div class="form-row">
            <div class="form-group">
              <label for="transactionAmount">Betrag (‚Ç¨)</label>
              <input
                type="number"
                id="transactionAmount"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label for="transactionType">Typ</label>
              <select id="transactionType" required>
                <option value="income">Einnahme</option>
                <option value="expense">Ausgabe</option>
              </select>
            </div>
            <div class="form-group">
              <label for="transactionCategory">Kategorie</label>
              <select id="transactionCategory" required></select>
            </div>
            <div class="form-group">
              <label for="transactionAccount">Konto</label>
              <select id="transactionAccount" required></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="transactionDescription"
                >Beschreibung (optional)</label
              >
              <input type="text" id="transactionDescription" />
            </div>
            <div class="form-group">
              <label for="transactionDate">Datum</label>
              <input type="date" id="transactionDate" required />
            </div>
            <div class="form-group">
              <button type="submit">Hinzuf√ºgen</button>
            </div>
          </div>
        </form>

        <div class="search-box">
          <label for="transactionSearch">Transaktionen durchsuchen</label>
          <input
            type="text"
            id="transactionSearch"
            placeholder="Nach Beschreibung oder Kategorie suchen..."
          />
        </div>

        <div class="transaction-list" id="transactionList"></div>
      </div>
      <!-- Fixkosten Tab -->
      <div id="fixedcosts" class="tab-content">
        <h2>Fixkosten verwalten</h2>
        <form id="fixedCostForm">
          <div class="form-row">
            <div class="form-group">
              <label for="fixedName">Name</label>
              <input type="text" id="fixedName" required />
            </div>
            <div class="form-group">
              <label for="fixedAmount">Betrag (‚Ç¨)</label>
              <input type="number" id="fixedAmount" step="0.01" required />
            </div>
            <div class="form-group">
              <label for="fixedCostCategory">Kategorie</label>
              <select id="fixedCostCategory" required></select>
            </div>
            <div class="form-group">
              <label for="fixedCostAccount">Konto</label>
              <select id="fixedCostAccount" required></select>
              </div>
            <div class="form-group">
              <button type="submit">Fixkosten speichern</button>
            </div>
          </div>
        </form>
        <h3>Aktuelle Fixkosten</h3>
        <div id="fixedCostList"></div>
      </div>

      <!-- Sparziele Tab -->
      <div id="goals" class="tab-content">
        <h2>Neues Sparziel anlegen</h2>
        <form id="goalForm">
          <div class="form-row">
            <div class="form-group">
              <label for="goalName">Ziel Name</label>
              <input type="text" id="goalName" required />
            </div>
            <div class="form-group">
              <label for="goalAmount">Zielbetrag (‚Ç¨)</label>
              <input type="number" id="goalAmount" step="0.01" required />
            </div>
            <div class="form-group">
              <label for="goalDate">Zieldatum</label>
              <input type="date" id="goalDate" required />
            </div>
            <div class="form-group"> <label for="goalAccount">Konto</label>
                <select id="goalAccount" required></select>
            </div>
            <div class="form-group">
              <button type="submit">Ziel erstellen</button>
            </div>
          </div>
        </form>

        <h3>Meine Sparziele</h3>
        <div id="goalsList"></div>
      </div>

      <!-- √úbersicht Tab -->
      <div id="overview" class="tab-content">
        <h2>Finanz√ºbersicht</h2>
        <div class="filter-section" style="margin-bottom: 20px;">
        <label for="overviewFilterAccount">Konto ausw√§hlen:</label>
        <select id="overviewFilterAccount" style="padding: 8px; border-radius: 5px; border: 1px solid #444; background-color: #333; color: #e0e0e0;">
            <option value="all">Alle Konten</option>
            </select>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalIncome">0,00 ‚Ç¨</div>
            <div class="stat-label">Gesamte Einnahmen</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalExpenses">0,00 ‚Ç¨</div>
            <div class="stat-label">Gesamte Ausgaben</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="monthlyIncome">0,00 ‚Ç¨</div>
            <div class="stat-label">Einnahmen diesen Monat</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="monthlyExpenses">0,00 ‚Ç¨</div>
            <div class="stat-label">Ausgaben diesen Monat</div>
          </div>
        </div>
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Diagramme</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
            <div class="chart-container" style="background-color: #2a2a2a; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 100%; max-width: 500px;">
                <canvas id="categoryChart"></canvas>
                <p style="text-align: center; margin-top: 10px; color: #bbb;">Ausgaben nach Kategorien</p>
            </div>
            <div class="chart-container" style="background-color: #2a2a2a; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 100%; max-width: 700px;">
                <canvas id="monthlyChart"></canvas>
                <p style="text-align: center; margin-top: 10px; color: #bbb;">Einnahmen & Ausgaben pro Monat</p>
            </div>
        </div>
        <div style="margin-top: 30px">
          <button onclick="exportDataToJson()">üìä Daten als JSON exportieren</button>
          <button onclick="triggerJsonImport()" class="btn-secondary">
              üìÅ Daten aus JSON importieren
          </button>
          <input
              type="file"
              id="jsonFileInput" accept=".json"     style="display: none"
              onchange="handleJsonImport(event)" />
        </div>
      </div>
      <div id="categories" class="tab-content">
        <h2>Kategorien verwalten</h2>
        <h3 style="margin-top: 20px;">Neue Kategorie hinzuf√ºgen</h3>
        <form id="categoryForm">
          <div class="form-row">
            <div class="form-group">
              <label for="categoryName">Name der Kategorie</label>
              <input type="text" id="categoryName" required />
            </div>
            <div class="form-group">
              <label for="categoryType">Typ</label>
              <select id="categoryType" required>
                <option value="income">Einnahme</option>
                <option value="expense">Ausgabe</option>
              </select>
            </div>
            <div class="form-group">
              <button type="submit">Kategorie hinzuf√ºgen</button>
            </div>
          </div>
        </form>

        <div id="categoryList">
          </div>
      </div>
      <div id="accounts" class="tab-content">
        <h2>Konten verwalten</h2>
        <h3 style="margin-top: 20px;">Neues Konto hinzuf√ºgen</h3>
        <form id="accountForm">
          <div class="form-row">
            <div class="form-group">
              <label for="accountName">Kontoname</label>
              <input type="text" id="accountName" required />
            </div>
            <div class="form-group">
              <label for="accountType">Kontotyp</label>
              <select id="accountType" required>
                <option value="checking">Girokonto</option>
                <option value="savings">Sparkonto</option>
                <option value="investment">Investment Depot</option>
                <option value="crypto">Krypto Wallet</option>
                <option value="cash">Bargeld</option>
                <option value="credit">Kreditkarte</option>
                </select>
            </div>
            <div class="form-group">
              <button type="submit">Konto hinzuf√ºgen</button>
            </div>
          </div>
        </form>
      
        <h3 style="margin-top: 30px;">Meine Konten</h3>
        <div id="accountList">
          </div>
      </div>
    <script>
      // Datenstrukturen
      let transactions = JSON.parse(
        localStorage.getItem("transactions") || "[]"
      );
      let goals = JSON.parse(localStorage.getItem("goals") || "[]");

      let fixedCosts = JSON.parse(localStorage.getItem("fixedCosts") || "[]");
      let categories = JSON.parse(localStorage.getItem("categories") || "[]");
      let accounts = JSON.parse(localStorage.getItem("accounts") || "[]");
      // Standardkategorien
      if (categories.length === 0) {
        categories = [
          { id: 1, name: "Gehalt", type: "income" },
          { id: 2, name: "Freelancing", type: "income" },
          { id: 3, name: "Sonstiges Einkommen", type: "income" },
          { id: 4, name: "Lebensmittel", type: "expense" },
          { id: 5, name: "Miete", type: "expense" },
          { id: 6, name: "Transport", type: "expense" },
          { id: 7, name: "Entertainment", type: "expense" },
          { id: 8, name: "Kleidung", type: "expense" },
          { id: 9, name: "Gesundheit", type: "expense" },
          { id: 10, name: "Sparen", type: "expense" },
          { id: 11, name: "Sonstiges", type: "expense" },
        ];
        saveData(); // Speichere die initialen Kategorien
      }
      if (accounts.length === 0) {
        accounts = [
          { id: 1, name: "Hauptkonto", type: "checking" },
          { id: 2, name: "Sparkonto", type: "savings" },
          { id: 3, name: "Investment Depot", type: "investment" },
          { id: 4, name: "Krypto Wallet", type: "crypto" },
        ];
        saveData(); // Speichere die initialen Konten
      }
      // Initialisierung
      document.addEventListener("DOMContentLoaded", function () {
        // Aktuelles Datum setzen
        document.getElementById("transactionDate").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("goalDate").value = new Date(
          Date.now() + 365 * 24 * 60 * 60 * 1000
        )
          .toISOString()
          .split("T")[0];

        // Event Listeners
        document.getElementById("filterAccount").addEventListener("change", applyFilters);
        document.getElementById("overviewFilterAccount").addEventListener("change", function() { // NEU: Event Listener f√ºr √úbersicht-Filter
          updateOverviewStats(this.value);
        });
        document
          .getElementById("transactionForm")
          .addEventListener("submit", addTransaction);
        document.getElementById("goalForm").addEventListener("submit", addGoal);

        document
          .getElementById("transactionSearch")
          .addEventListener("input", filterTransactions);

        // Kategorien basierend auf Typ aktualisieren
        document
          .getElementById("transactionType")
          .addEventListener("change", populateTransactionCategories);
        document
          .getElementById("categoryForm")
          .addEventListener("submit", addCategory);
        document.getElementById("accountForm").addEventListener("submit", addAccount);

        saveData();
        // Initial laden
        updateDisplay();
        updateFixedCostsUI();
        populateTransactionCategories(); // Aktualisiert Transaktionskategorien
        populateFixedCostCategories(); // Aktualisiert Fixkostenkategorien
        populateAccountsDropdown();
        displayCategories();
        displayAccounts(); 
        displayGoals(); 
        updateOverviewStats(document.getElementById("overviewFilterAccount").value);
        renderCharts();
      });
      document
        .getElementById("fixedCostForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const cost = {
            id: Date.now(),
            name: document.getElementById("fixedName").value,
            amount: parseFloat(document.getElementById("fixedAmount").value),
            category: document.getElementById("fixedCostCategory").value,
            accountId: parseInt(document.getElementById("fixedCostAccount").value), // NEU: Konto-ID hinzuf√ºgen
          };

          fixedCosts.push(cost);
          saveData();
          updateFixedCostsUI();
          this.reset();
        });
      // Tab Navigation
      function showTab(tabName) {
        document
            .querySelectorAll(".tab")
            .forEach((tab) => tab.classList.remove("active"));
        document
            .querySelectorAll(".tab-content")
            .forEach((content) => content.classList.remove("active"));

        document
            .querySelector(`button[onclick="showTab('${tabName}')"]`)
            .classList.add("active");
        document.getElementById(tabName).classList.add("active");

        // Spezielle Aktualisierungen beim Tab-Wechsel
        if (tabName === "overview") {
            updateOverviewStats(document.getElementById("overviewFilterAccount").value);
            renderCharts();
        } else if (tabName === "transactions") {
            applyFilters(); // Stellt sicher, dass der Transaktionsfilter angewendet wird
        } else if (tabName === "fixedcosts") {
            updateFixedCostsUI();
        } else if (tabName === "goals") {
            displayGoals(); // Oder updateGoalsProgress(), je nachdem was die Hauptfunktion ist
        } else if (tabName === "categories") {
            displayCategories();
        } else if (tabName === "accounts") {
            displayAccounts();
        }
      }

      // Funktion zum Aktualisieren der Kategorie-Dropdowns
      function populateTransactionCategories() {
        const transactionType =
          document.getElementById("transactionType").value;
        const transactionCategorySelect = document.getElementById(
          "transactionCategory"
        );

        // Alte Optionen entfernen
        transactionCategorySelect.innerHTML = "";

        // Standard "Bitte w√§hlen" Option hinzuf√ºgen
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Bitte w√§hlen...";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        transactionCategorySelect.appendChild(defaultOption);

        const filteredCategories = categories.filter(
          (cat) => cat.type === transactionType
        );

        filteredCategories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.textContent = cat.name;
          transactionCategorySelect.appendChild(option);
        });
      }

      // Funktion zum Aktualisieren der Kategorie-Dropdowns f√ºr Fixkosten
      function populateFixedCostCategories() {
        const fixedCostCategorySelect =
          document.getElementById("fixedCostCategory");

        // √úberpr√ºfen, ob das Element existiert, bevor darauf zugegriffen wird
        if (!fixedCostCategorySelect) {
          console.warn("Element fixedCostCategory nicht gefunden.");
          return;
        }

        // Alte Optionen entfernen
        fixedCostCategorySelect.innerHTML = "";

        // Standard "Bitte w√§hlen" Option hinzuf√ºgen
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Bitte w√§hlen...";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        fixedCostCategorySelect.appendChild(defaultOption);

        // Nur Ausgabenkategorien f√ºr Fixkosten
        const expenseCategories = categories.filter(
          (cat) => cat.type === "expense"
        );

        expenseCategories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.textContent = cat.name;
          fixedCostCategorySelect.appendChild(option);
        });
      }
      
      // Dropdown f√ºr Konten bef√ºllen
      function populateAccountsDropdown() {
        const transactionAccountSelect = document.getElementById("transactionAccount");
        const filterAccountSelect = document.getElementById("filterAccount");
        const fixedCostAccountSelect = document.getElementById("fixedCostAccount");
        const goalAccountSelect = document.getElementById("goalAccount"); 
        const overviewFilterAccountSelect = document.getElementById("overviewFilterAccount");

        // Leere beide Dropdowns, au√üer der "Alle Konten"-Option im Filter-Dropdown
        transactionAccountSelect.innerHTML = "";
        filterAccountSelect.innerHTML = '<option value="all">Alle Konten</option>';
        fixedCostAccountSelect.innerHTML = "";
        goalAccountSelect.innerHTML = "";
        overviewFilterAccountSelect.innerHTML = '<option value="all">Alle Konten</option>';

        if (accounts.length === 0) {
          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "Keine Konten verf√ºgbar";
          defaultOption.disabled = true;
          defaultOption.selected = true;
          transactionAccountSelect.appendChild(defaultOption.cloneNode(true)); 
          fixedCostAccountSelect.appendChild(defaultOption.cloneNode(true));
          goalAccountSelect.appendChild(defaultOption.cloneNode(true)); 
          return;
        }

        accounts.forEach((account) => {
          const optionTransaction = document.createElement("option");
          optionTransaction.value = account.id; 
          optionTransaction.textContent = account.name;
          transactionAccountSelect.appendChild(optionTransaction);

          const optionFilter = document.createElement("option");
          optionFilter.value = account.id;
          optionFilter.textContent = account.name;
          filterAccountSelect.appendChild(optionFilter);

          const optionFixedCost = document.createElement("option"); 
          optionFixedCost.value = account.id;
          optionFixedCost.textContent = account.name;
          fixedCostAccountSelect.appendChild(optionFixedCost);

          const optionGoal = document.createElement("option");
          optionGoal.value = account.id;
          optionGoal.textContent = account.name;
          goalAccountSelect.appendChild(optionGoal);

          const optionOverviewFilter = document.createElement("option");
          optionOverviewFilter.value = account.id;
          optionOverviewFilter.textContent = account.name;
          overviewFilterAccountSelect.appendChild(optionOverviewFilter);
        });
      }
      // Funktion zum Aktualisieren der Statistik-Karten im √úbersicht-Tab
      function updateOverviewStats(accountIdFilter = "all") {
            let transactionsToConsider = transactions;

            if (accountIdFilter !== "all") {
                transactionsToConsider = transactions.filter(
                    (t) => t.accountId === parseInt(accountIdFilter)
                );
            }

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let totalIncome = 0;
            let totalExpenses = 0;
            let monthlyIncome = 0;
            let monthlyExpenses = 0;

            transactionsToConsider.forEach((t) => {
                const transactionDate = new Date(t.date);
                const isCurrentMonth =
                    transactionDate.getMonth() === currentMonth &&
                    transactionDate.getFullYear() === currentYear;

                if (t.type === "income") {
                    totalIncome += t.amount;
                    if (isCurrentMonth) {
                        monthlyIncome += t.amount;
                    }
                } else {
                    totalExpenses += t.amount;
                    if (isCurrentMonth) {
                        monthlyExpenses += t.amount;
                    }
                }
            });

            document.getElementById("totalIncome").textContent = formatCurrency(totalIncome);
            document.getElementById("totalExpenses").textContent = formatCurrency(totalExpenses);
            document.getElementById("monthlyIncome").textContent = formatCurrency(monthlyIncome);
            document.getElementById("monthlyExpenses").textContent = formatCurrency(monthlyExpenses);
            renderCharts();
        }
      // Filter anwenden und Display aktualisieren
      function applyFilters() {
        const selectedAccountId = document.getElementById("filterAccount").value;
        let filteredTransactions = [...transactions]; // Kopie der Transaktionen

        if (selectedAccountId !== "all") {
          filteredTransactions = filteredTransactions.filter(
            (t) => t.accountId === parseInt(selectedAccountId)
          );
        }

        // Sortiere gefilterte Transaktionen vom Neuesten zum √Ñltesten f√ºr die Anzeige
        filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

        displayTransactions(filteredTransactions);
        updateBalance(selectedAccountId); // Balance f√ºr das gefilterte Konto aktualisieren
      }
      
      // Globale Variablen f√ºr Diagramm-Instanzen, damit wir sie aktualisieren k√∂nnen
      let categoryChartInstance = null;
      let monthlyChartInstance = null;

      // Funktion zum Rendern der Diagramme
      function renderCharts() {
          const accountIdFilter = document.getElementById("overviewFilterAccount").value;
          let transactionsToConsider = transactions;

          if (accountIdFilter !== "all") {
              transactionsToConsider = transactions.filter(
                  (t) => t.accountId === parseInt(accountIdFilter)
              );
          }

          // --- 1. Ausgaben nach Kategorien (Kreisdiagramm) ---
          const expenseCategories = {};
          transactionsToConsider.forEach((t) => {
              if (t.type === "expense") {
                  expenseCategories[t.category] =
                      (expenseCategories[t.category] || 0) + t.amount;
              }
          });

          const categoryLabels = Object.keys(expenseCategories);
          const categoryData = Object.values(expenseCategories);

          const categoryCtx = document.getElementById("categoryChart").getContext("2d");

          // Zerst√∂re alte Instanz, falls vorhanden
          if (categoryChartInstance) {
              categoryChartInstance.destroy();
          }

          categoryChartInstance = new Chart(categoryCtx, {
              type: "pie",
              data: {
                  labels: categoryLabels,
                  datasets: [{
                      data: categoryData,
                      backgroundColor: [
                          "#FF6384",
                          "#36A2EB",
                          "#FFCE56",
                          "#4BC0C0",
                          "#9966FF",
                          "#FF9F40",
                          "#E7E9ED",
                          "#C9CBCE",
                          "#7B68EE",
                          "#20B2AA",
                      ],
                      hoverBackgroundColor: [
                          "#FF6384",
                          "#36A2EB",
                          "#FFCE56",
                          "#4BC0C0",
                          "#9966FF",
                          "#FF9F40",
                          "#E7E9ED",
                          "#C9CBCE",
                          "#7B68EE",
                          "#20B2AA",
                      ],
                  }, ],
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: {
                          position: "right",
                          labels: {
                              color: "#e0e0e0", // Legendenfarbe anpassen
                          },
                      },
                      title: {
                          display: true,
                          text: "Ausgaben nach Kategorien",
                          color: "#e0e0e0", // Titeltextfarbe anpassen
                      },
                  },
              },
          });

          // --- 2. Einnahmen & Ausgaben pro Monat (Balkendiagramm) ---
          const monthlyData = {};
          transactionsToConsider.forEach((t) => {
              const date = new Date(t.date);
              const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, "0")}`; // YYYY-MM Format

              if (!monthlyData[monthYear]) {
                  monthlyData[monthYear] = { income: 0, expense: 0 };
              }

              if (t.type === "income") {
                  monthlyData[monthYear].income += t.amount;
              } else {
                  monthlyData[monthYear].expense += t.amount;
              }
          });

          const sortedMonths = Object.keys(monthlyData).sort();
          const monthlyLabels = sortedMonths.map((monthYear) => {
              const [year, month] = monthYear.split("-");
              return new Date(year, month - 1).toLocaleString("de-DE", {
                  month: "short",
                  year: "numeric",
              });
          });
          const monthlyIncomeData = sortedMonths.map((month) => monthlyData[month].income);
          const monthlyExpenseData = sortedMonths.map((month) => monthlyData[month].expense);

          const monthlyCtx = document.getElementById("monthlyChart").getContext("2d");

          // Zerst√∂re alte Instanz, falls vorhanden
          if (monthlyChartInstance) {
              monthlyChartInstance.destroy();
          }

          monthlyChartInstance = new Chart(monthlyCtx, {
              type: "bar",
              data: {
                  labels: monthlyLabels,
                  datasets: [{
                      label: "Einnahmen",
                      data: monthlyIncomeData,
                      backgroundColor: "rgba(75, 192, 192, 0.6)",
                      borderColor: "rgba(75, 192, 192, 1)",
                      borderWidth: 1,
                  }, {
                      label: "Ausgaben",
                      data: monthlyExpenseData,
                      backgroundColor: "rgba(255, 99, 132, 0.6)",
                      borderColor: "rgba(255, 99, 132, 1)",
                      borderWidth: 1,
                  }, ],
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: {
                          position: "top",
                          labels: {
                              color: "#e0e0e0",
                          },
                      },
                      title: {
                          display: true,
                          text: "Monatliche Einnahmen & Ausgaben",
                          color: "#e0e0e0",
                      },
                  },
                  scales: {
                      x: {
                          ticks: {
                              color: "#e0e0e0", // Achsenbeschriftung X-Achse
                          },
                          grid: {
                              color: "rgba(255,255,255,0.1)", // Gitterlinien X-Achse
                          },
                      },
                      y: {
                          beginAtZero: true,
                          ticks: {
                              color: "#e0e0e0", // Achsenbeschriftung Y-Achse
                              callback: function(value) { // W√§hrung formatieren
                                  return formatCurrency(value);
                              }
                          },
                          grid: {
                              color: "rgba(255,255,255,0.1)", // Gitterlinien Y-Achse
                          },
                      },
                  },
              },
          });
      }
      // Funktion zum Abrufen des Kontonamens basierend auf der ID
      function getAccountName(accountId) {
        if (!accounts || accounts.length === 0) {
            loadData();
        }
        const account = accounts.find(acc => acc.id === accountId);
        return account ? account.name : "Unbekanntes Konto";
      }
      // Transaktion hinzuf√ºgen
      function addTransaction(e) {
        e.preventDefault();

        const transaction = {
          id: Date.now(),
          amount: parseFloat(
            document.getElementById("transactionAmount").value
          ),
          type: document.getElementById("transactionType").value,
          category: document.getElementById("transactionCategory").value,
          description:
            document.getElementById("transactionDescription").value ||
            "Keine Beschreibung",
          date: document.getElementById("transactionDate").value,
          accountId: parseInt(document.getElementById("transactionAccount").value),
        };

        transactions.push(transaction);
        saveData();
        updateDisplay();

        // Form zur√ºcksetzen
        document.getElementById("transactionForm").reset();
        document.getElementById("transactionDate").value = new Date()
          .toISOString()
          .split("T")[0];
        populateAccountsDropdown();
      }

      // Konto hinzuf√ºgen
      function addAccount(e) {
        e.preventDefault();
        const nameInput = document.getElementById("accountName");
        const typeInput = document.getElementById("accountType");

        const name = nameInput.value.trim();
        const type = typeInput.value;

        if (name && type) {
          // Pr√ºfen, ob Konto mit gleichem Namen bereits existiert (case-insensitive)
          const accountExists = accounts.some(
            (acc) => acc.name.toLowerCase() === name.toLowerCase()
          );

          if (accountExists) {
            alert(`Ein Konto namens "${name}" existiert bereits.`);
            return;
          }

          const newAccount = {
            id: Date.now(), // Eindeutige ID
            name: name,
            type: type,
          };
          accounts.push(newAccount);
          saveData(); // Konten speichern
          displayAccounts(); // Kontenliste aktualisieren
          populateAccountsDropdown(); // Transaktions-Dropdowns aktualisieren
          nameInput.value = ""; // Formularfelder leeren
        }
      }

      // Konten anzeigen
      function displayAccounts() {
          const accountList = document.getElementById("accountList");
          accountList.innerHTML = ""; // Liste leeren

          if (accounts.length === 0) {
            accountList.innerHTML =
              "<p style='text-align: center; padding: 40px; color: #aaa;'>Noch keine Konten hinzugef√ºgt.</p>";
            return;
          }

          accounts.forEach((account) => {
            const accountItem = document.createElement("div");
            accountItem.className = "category-item"; // Wiederverwenden des category-item-Styles f√ºr einheitliches Aussehen
            accountItem.innerHTML = `
              <span>${account.name} (${account.type})</span>
              <div>
                  <button onclick="editAccount(${account.id}, '${account.name}', '${account.type}')">Bearbeiten</button>
                  <button onclick="deleteAccount(${account.id})" class="btn-danger">L√∂schen</button>
              </div>
            `;
            accountList.appendChild(accountItem);
          });
        }

      // Konto l√∂schen
      function deleteAccount(id) {
          // Pr√ºfen, ob Transaktionen mit diesem Konto verkn√ºpft sind
          const hasTransactions = transactions.some(t => t.accountId === id);

          if (hasTransactions) {
            alert("Dieses Konto kann nicht gel√∂scht werden, da noch Transaktionen damit verkn√ºpft sind. Bitte l√∂schen oder verschieben Sie zuerst die Transaktionen dieses Kontos.");
            return;
          }

          if (confirm("Sind Sie sicher, dass Sie dieses Konto l√∂schen m√∂chten?")) {
            accounts = accounts.filter((acc) => acc.id !== id);
            saveData();
            displayAccounts(); // Kontenliste aktualisieren
            populateAccountsDropdown(); // Transaktions-Dropdowns aktualisieren
            updateDisplay(); // Balance und Transaktionsliste k√∂nnten betroffen sein
          }
        }

        // Konto bearbeiten
      function editAccount(id, currentName, currentType) {
        let newName = prompt(
          `Geben Sie den neuen Namen f√ºr das Konto "${currentName}" (${currentType}) ein:`,
          currentName
        );

        if (newName === null || newName.trim() === "") {
          return; // Abbruch oder leere Eingabe
        }

        newName = newName.trim();

        // Pr√ºfen, ob der neue Name bereits f√ºr ein anderes Konto existiert (case-insensitive)
        const accountExists = accounts.some(
          (acc) => acc.id !== id && acc.name.toLowerCase() === newName.toLowerCase()
        );

        if (accountExists) {
          alert(`Ein Konto namens "${newName}" existiert bereits.`);
          return;
        }

        const accountIndex = accounts.findIndex((acc) => acc.id === id);
        if (accountIndex !== -1) {
          const oldName = accounts[accountIndex].name; // Speichere alten Namen f√ºr m√∂gliche zuk√ºnftige Verwendungen

          accounts[accountIndex].name = newName;
          // Kontotyp wird hier nicht ge√§ndert, da es im Prompt nicht angeboten wird.
          // Falls gew√ºnscht, m√ºsste man dies ebenfalls abfragen.

          saveData();
          displayAccounts();
          populateAccountsDropdown(); // Aktualisiert die Dropdowns f√ºr Transaktionen
          updateDisplay(); // Aktualisiert die Anzeige, falls Transaktionen den alten Namen anzeigen
        }
      }

      function updateFixedCostsUI() {
        const list = document.getElementById("fixedCostList");
        if (!fixedCosts.length) {
            list.innerHTML =
                '<div style="text-align:center; color:#aaa;">Keine Fixkosten eingetragen</div>';
            return;
        }

        list.innerHTML = fixedCosts
            .map(
                (f) => `
                    <div class="transaction-item">
                        <div class="transaction-details">
                            <div class="transaction-amount expense">-${formatCurrency(
                                f.amount
                            )}</div>
                            <div class="transaction-meta">
                                <strong>${f.name}</strong> ‚Ä¢ ${f.category}
                                <br>
                                <span style="font-size:0.85em; color:#888;">Konto: ${getAccountName(f.accountId)}</span> </div>
                        </div>
                        <button onclick="addFixedCost(${
                            f.id
                        })">Eintragen</button>
                        <button onclick="deleteFixedCost(${
                            f.id
                        })" class="btn-danger">L√∂schen</button>
                    </div>
                `
            )
            .join("");
    }

      function addFixedCost(id) {
        const cost = fixedCosts.find((c) => c.id === id);
        if (!cost) return;

        const transaction = {
            id: Date.now(),
            amount: cost.amount,
            type: "expense",
            category: cost.category,
            description: `Fixkosten: ${cost.name}`,
            date: new Date().toISOString().split("T")[0],
            accountId: cost.accountId, // NEU: accountId von der Fixkostenposition √ºbernehmen
        };

        transactions.push(transaction);
        saveData();
        updateDisplay();
        alert(`Fixkosten "${cost.name}" als Ausgabe eingetragen.`);
    }

      function deleteFixedCost(id) {
        if (confirm("Fixkosten l√∂schen?")) {
          fixedCosts = fixedCosts.filter((c) => c.id !== id);
          saveData();
          updateFixedCostsUI();
        }
      }

      // Kategorie hinzuf√ºgen
      function addCategory(e) {
        e.preventDefault();
        const nameInput = document.getElementById("categoryName");
        const typeInput = document.getElementById("categoryType");

        const name = nameInput.value.trim();
        const type = typeInput.value;

        if (name && type) {
          // √úberpr√ºfen, ob Kategorie bereits existiert (case-insensitive)
          const categoryExists = categories.some(
            (cat) =>
              cat.name.toLowerCase() === name.toLowerCase() && cat.type === type
          );

          if (categoryExists) {
            alert(`Die Kategorie "${name}" (${type}) existiert bereits.`);
            return;
          }

          const newCategory = {
            id: Date.now(),
            name: name,
            type: type,
          };
          categories.push(newCategory);
          saveData();
          displayCategories(); // Kategorienliste aktualisieren
          populateTransactionCategories(); // Dropdowns aktualisieren
          populateFixedCostCategories();
          nameInput.value = ""; // Formularfelder leeren
        }
      }

      // Kategorien anzeigen
      function displayCategories() {
        const categoryList = document.getElementById("categoryList"); // Dies ist der Hauptcontainer f√ºr alle Kategorien
        categoryList.innerHTML = "";

        if (categories.length === 0) {
          categoryList.innerHTML =
            "<p style='text-align: center; padding: 40px; color: #aaa;'>Noch keine Kategorien hinzugef√ºgt.</p>";
          return;
        }

        const incomeCategories = categories.filter(
          (cat) => cat.type === "income"
        );
        const expenseCategories = categories.filter(
          (cat) => cat.type === "expense"
        );

        const renderCategorySection = (title, categoryArray) => {
          if (categoryArray.length > 0) {
            const section = document.createElement("div");
            section.innerHTML = `<h4 style="margin-top: 20px;">${title}</h4>`; // F√ºge etwas Abstand hinzu
            const ul = document.createElement("ul");
            ul.style.listStyleType = "none"; // Entferne Standard-Listenpunkte
            ul.style.padding = "0"; // Entferne Standard-Padding

            categoryArray.forEach((category) => {
              const li = document.createElement("li");
              li.className = "category-item"; // WICHTIG: F√ºge diese Klasse hinzu
              li.innerHTML = `
                <span>${category.name}</span>
                <button onclick="editCategory(${category.id}, '${category.name}', '${category.type}')">Bearbeiten</button>
                <button onclick="deleteCategory(${category.id})" class="btn-danger">L√∂schen</button>
              `;
              ul.appendChild(li);
            });
            section.appendChild(ul);
            categoryList.appendChild(section);
          } else {
            // Optional: Nachricht, wenn keine Kategorien im Abschnitt vorhanden sind
            const section = document.createElement("div");
            section.innerHTML = `<h4 style="margin-top: 20px;">${title}</h4><p style="color:#aaa; margin-left: 15px;">Keine ${title
              .toLowerCase()
              .replace("-kategorien", "")}-Kategorien vorhanden.</p>`;
            categoryList.appendChild(section);
          }
        };

        renderCategorySection("Einnahme-Kategorien", incomeCategories);
        renderCategorySection("Ausgabe-Kategorien", expenseCategories);
      }
      // Kategorie l√∂schen
      function deleteCategory(id) {
        if (
          !confirm(
            "Sind Sie sicher, dass Sie diese Kategorie l√∂schen m√∂chten? Alle Transaktionen, die diese Kategorie verwenden, werden als 'Unkategorisiert' markiert."
          )
        ) {
          return;
        }

        const categoryToDelete = categories.find((cat) => cat.id === id);
        if (!categoryToDelete) return;

        // Kategorien aktualisieren
        categories = categories.filter((cat) => cat.id !== id);

        // Transaktionen anpassen: Kategorien auf "Unkategorisiert" setzen
        transactions.forEach((t) => {
          if (
            t.category.toLowerCase() === categoryToDelete.name.toLowerCase() &&
            t.type === categoryToDelete.type
          ) {
            t.category = "Unkategorisiert";
          }
        });

        // Fixkosten anpassen
        fixedCosts.forEach((fc) => {
          if (
            fc.category.toLowerCase() === categoryToDelete.name.toLowerCase()
          ) {
            fc.category = "Unkategorisiert";
          }
        });

        saveData();
        displayCategories();
        updateDisplay(); // Transaktionsliste und Saldo aktualisieren
        updateFixedCostsUI(); // F√ºge diese Zeile hinzu, um die Fixkostenliste zu aktualisieren
        populateTransactionCategories(); // Dropdowns aktualisieren
        populateFixedCostCategories();
      }
      // Neue Funktion: Kategorie bearbeiten
      function editCategory(id, currentName, currentType) {
        let newName = prompt(
          `Geben Sie den neuen Namen f√ºr die Kategorie "${currentName}" (${currentType}) ein:`,
          currentName
        );

        if (newName === null || newName.trim() === "") {
          return; // Abbruch oder leere Eingabe
        }

        newName = newName.trim();

        // √úberpr√ºfen, ob der neue Name bereits f√ºr den gleichen Typ existiert (case-insensitive)
        const categoryExists = categories.some(
          (cat) =>
            cat.id !== id &&
            cat.name.toLowerCase() === newName.toLowerCase() &&
            cat.type === currentType
        );

        if (categoryExists) {
          alert(
            `Eine Kategorie namens "${newName}" (${currentType}) existiert bereits.`
          );
          return;
        }

        const categoryIndex = categories.findIndex((cat) => cat.id === id);
        if (categoryIndex !== -1) {
          const oldName = categories[categoryIndex].name;
          categories[categoryIndex].name = newName;

          // Transaktionen anpassen: Alten Kategorienamen durch neuen ersetzen
          transactions.forEach((t) => {
            if (
              t.category.toLowerCase() === oldName.toLowerCase() &&
              t.type === currentType
            ) {
              t.category = newName;
            }
          });

          // Fixkosten anpassen: Alten Kategorienamen durch neuen ersetzen
          fixedCosts.forEach((fc) => {
            if (fc.category.toLowerCase() === oldName.toLowerCase()) {
              fc.category = newName;
            }
          });

          saveData();
          displayCategories();
          updateDisplay(); // Transaktionsliste und Saldo aktualisieren
          updateFixedCostsUI(); // F√ºge diese Zeile hinzu, um die Fixkostenliste zu aktualisieren
          populateTransactionCategories(); // Dropdowns aktualisieren
          populateFixedCostCategories();
        }
      }

      // Sparziel hinzuf√ºgen
      function addGoal(e) {
        e.preventDefault();

        const goal = {
          id: Date.now(),
          name: document.getElementById("goalName").value,
          targetAmount: parseFloat(document.getElementById("goalAmount").value),
          currentAmount: 0,
          targetDate: document.getElementById("goalDate").value,
          created: new Date().toISOString().split("T")[0],
          accountId: parseInt(document.getElementById("goalAccount").value),
        };

        goals.push(goal);
        saveData();
        updateDisplay();

        document.getElementById("goalForm").reset();
        document.getElementById("goalDate").value = new Date(
          Date.now() + 365 * 24 * 60 * 60 * 1000
        )
          .toISOString()
          .split("T")[0];
      }

      // Sparziel l√∂schen
      function deleteGoal(id) {
        if (confirm("Sparziel wirklich l√∂schen?")) {
          goals = goals.filter((goal) => goal.id !== id);
          saveData();
          updateDisplay();
        }
      }

      // Geld zu Sparziel hinzuf√ºgen
      function addToGoal(id) {
        const amount = prompt("Betrag hinzuf√ºgen (‚Ç¨):");
        if (amount && !isNaN(amount)) {
          const goal = goals.find((g) => g.id === id);
          if (goal) {
            goal.currentAmount += parseFloat(amount);

            // Transaktion erstellen
            const transaction = {
              id: Date.now(),
              amount: parseFloat(amount),
              type: "expense",
              category: "Sparen",
              description: `Sparziel: ${goal.name}`,
              date: new Date().toISOString().split("T")[0],
              accountId: goal.accountId,
              linkedType: "goal",
              linkedId: goal.id,
            };

            transactions.push(transaction);
            saveData();
            updateDisplay();
          }
        }
      }

      // Transaktion l√∂schen
      function deleteTransaction(id) {
        const t = transactions.find((t) => t.id === id);
        if (!t) return;

        if (confirm("Transaktion wirklich l√∂schen?")) {
          // R√ºckbuchung bei Sparziel
          if (t.linkedType === "goal") {
            const goal = goals.find((g) => g.id === t.linkedId);
            if (goal) {
              goal.currentAmount = Math.max(0, goal.currentAmount - t.amount);
            }
          }

          transactions = transactions.filter((tr) => tr.id !== id);
          saveData();
          updateDisplay();
        }
      }

      // Transaktionen filtern
      function filterTransactions() {
        const searchTerm = document
          .getElementById("transactionSearch")
          .value.toLowerCase();
        const filteredTransactions = transactions.filter(
          (t) =>
            t.description.toLowerCase().includes(searchTerm) ||
            t.category.toLowerCase().includes(searchTerm)
        );
        displayTransactions(filteredTransactions);
      }
      // Filter anwenden und Display aktualisieren
      function applyFilters() {
          const selectedAccountId = document.getElementById("filterAccount").value;
          let filteredTransactions = [...transactions]; // Kopie der Transaktionen

          if (selectedAccountId !== "all") {
            filteredTransactions = filteredTransactions.filter(
              (t) => t.accountId === parseInt(selectedAccountId)
            );
          }

          // Sortiere gefilterte Transaktionen vom Neuesten zum √Ñltesten f√ºr die Anzeige
          filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

          displayTransactions(filteredTransactions);
          updateBalance(selectedAccountId); // Balance f√ºr das gefilterte Konto aktualisieren

          displayGoals();
          updateStats();
      }
      // Display-Funktionen
      function updateDisplay() {
        applyFilters();
        // updateBalance();
        // displayTransactions(transactions);
        // displayGoals();
        // updateStats();
      }

      // Balance aktualisieren (jetzt optional nach Konto gefiltert)
      function updateBalance(accountIdFilter = "all") {
        let transactionsToConsider = transactions;

        if (accountIdFilter !== "all") {
          transactionsToConsider = transactions.filter(
            (t) => t.accountId === parseInt(accountIdFilter)
          );
        }

        const balance = transactionsToConsider.reduce((sum, t) => {
          return sum + (t.type === "income" ? t.amount : -t.amount);
        }, 0);

        const totalSaved = goals.reduce((sum, g) => sum + g.currentAmount, 0); // Diese bleibt global, da Sparziele nicht kontospezifisch sind

        document.getElementById("totalBalance").textContent =
          formatCurrency(balance);
        document.getElementById("totalSavedDisplay").textContent =
          formatCurrency(totalSaved);
      }

      function displayTransactions(transactionsToShow) {
        const list = document.getElementById("transactionList");

        if (transactionsToShow.length === 0) {
          list.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #aaa;">Keine Transaktionen gefunden</div>';
          return;
        }

        // Gruppiere nach Monat (YYYY-MM)
        const grouped = {};
        for (const t of transactionsToShow) {
          const monthKey = t.date.slice(0, 7); // "2025-06"
          if (!grouped[monthKey]) grouped[monthKey] = [];
          grouped[monthKey].push(t);
        }

        // Monate sortieren (neuester zuerst)
        const sortedMonths = Object.keys(grouped).sort(
          (a, b) => new Date(b) - new Date(a)
        );

        list.innerHTML = sortedMonths
          .map((month) => {
            const transactionsHTML = grouped[month]
              .sort((a, b) => new Date(b.date) - new Date(a.date)) // innerhalb des Monats
              .map(
                (t) => `
                    <div class="transaction-item">
                        <div class="transaction-details">
                            <div class="transaction-amount ${t.type}">
                                ${
                                  t.type === "income" ? "+" : "-"
                                }${formatCurrency(t.amount)}
                            </div>
                            <div class="transaction-meta">
                                <strong>${t.description}</strong> ‚Ä¢ ${
                  t.category
                } ‚Ä¢ ${formatDate(t.date)} ‚Ä¢
                 <span>${getAccountName(t.accountId)}</span>
                            </div>
                        </div>
                        <button onclick="deleteTransaction(${
                          t.id
                        })" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">L√∂schen</button>
                    </div>
                `
              )
              .join("");

            const monthName = new Date(month + "-01").toLocaleDateString(
              "de-DE",
              {
                month: "long",
                year: "numeric",
              }
            );

            return `
                <h3 style="margin: 20px 0 10px 15px; color: #667eea; border-bottom: 1px solid #444;">${
                  monthName.charAt(0).toUpperCase() + monthName.slice(1)
                }</h3>
                ${transactionsHTML}
            `;
          })
          .join("");
      }

      function spendGoal(id) {
        const goal = goals.find((g) => g.id === id);
        if (!goal || goal.currentAmount === 0) {
          alert("Dieses Ziel enth√§lt kein Erspartes.");
          return;
        }

        if (
          !confirm(
            `Willst du das Geld f√ºr "${goal.name}" als Ausgabe verbuchen?`
          )
        )
          return;

        goal.currentAmount = 0;

        saveData();
        updateDisplay();
      }

      function displayGoals() {
        const list = document.getElementById("goalsList");

        if (goals.length === 0) {
          list.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #aaa;">Keine Sparziele angelegt</div>';
          return;
        }

        list.innerHTML = goals
          .map((goal) => {
            const progress = (goal.currentAmount / goal.targetAmount) * 100;
            const daysLeft = Math.ceil(
              (new Date(goal.targetDate) - new Date()) / (1000 * 60 * 60 * 24)
            );
            const monthlyNeeded =
              daysLeft > 0
                ? (goal.targetAmount - goal.currentAmount) / (daysLeft / 30)
                : 0;

            return `
                    <div class="goal-item">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <h4>${goal.name}</h4>
                            <div>
                                <button onclick="addToGoal(${
                                  goal.id
                                })" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">Geld hinzuf√ºgen</button>
                                <button onclick="deleteGoal(${
                                  goal.id
                                })" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">L√∂schen</button>
                                <button onclick="spendGoal(${
                                  goal.id
                                })" style="padding: 5px 10px; font-size: 12px;">Ziel ausgeben</button>

                            </div>
                        </div>
                        <div>Fortschritt: ${formatCurrency(
                          goal.currentAmount
                        )} / ${formatCurrency(goal.targetAmount)}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(
                              progress,
                              100
                            )}%"></div>
                        </div>
                        <div style="font-size: 0.9rem; color: #aaa;">
                            ${Math.round(progress)}% erreicht ‚Ä¢ 
                            ${
                              daysLeft > 0
                                ? `${daysLeft} Tage verbleibend`
                                : "Zieldatum erreicht"
                            } ‚Ä¢ 
                            ${
                              monthlyNeeded > 0
                                ? `${formatCurrency(monthlyNeeded)}/Monat n√∂tig`
                                : "Ziel erreicht!"
                            }
                            <br>
                            <span style="font-size:0.85em; color:#888;">Konto: ${getAccountName(goal.accountId)}</span>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function updateStats() {
        const totalIncome = transactions
          .filter((t) => t.type === "income")
          .reduce((sum, t) => sum + t.amount, 0);
        const totalExpenses = transactions
          .filter((t) => t.type === "expense")
          .reduce((sum, t) => sum + t.amount, 0);

        const currentMonth = new Date().toISOString().slice(0, 7);
        const monthlyIncome = transactions
          .filter((t) => t.type === "income" && t.date.startsWith(currentMonth))
          .reduce((sum, t) => sum + t.amount, 0);
        const monthlyExpenses = transactions
          .filter(
            (t) => t.type === "expense" && t.date.startsWith(currentMonth)
          )
          .reduce((sum, t) => sum + t.amount, 0);

        document.getElementById("totalIncome").textContent =
          formatCurrency(totalIncome);
        document.getElementById("totalExpenses").textContent =
          formatCurrency(totalExpenses);
        document.getElementById("monthlyIncome").textContent =
          formatCurrency(monthlyIncome);
        document.getElementById("monthlyExpenses").textContent =
          formatCurrency(monthlyExpenses);
      }

      // Neue Funktion zum Exportieren aller Daten als JSON
      function exportDataToJson() {
          const allData = {
              transactions: transactions,
              fixedCosts: fixedCosts,
              goals: goals,
              categories: categories,
              accounts: accounts,
          };

          const jsonData = JSON.stringify(allData, null, 2); // null, 2 f√ºr sch√∂ne Formatierung

          const blob = new Blob([jsonData], { type: "application/json;charset=utf-8;" });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute(
              "download",
              `finanztracker_backup_${new Date().toISOString().split("T")[0]}.json`
          );
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          alert("Alle Daten erfolgreich als JSON exportiert!");
      }
      
      function triggerJsonImport() {
          document.getElementById("jsonFileInput").click();
      }

// Neue Funktion zum Importieren aller Daten aus JSON
      function handleJsonImport(event) {
          const file = event.target.files[0];
          if (!file) {
              alert("Keine Datei ausgew√§hlt.");
              return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
              try {
                  const importedData = JSON.parse(e.target.result);

                  // Daten aus der JSON-Datei zuweisen
                  // Wichtig: Pr√ºfen, ob die Daten im Import vorhanden sind, um Fehler zu vermeiden
                  transactions = importedData.transactions || [];
                  fixedCosts = importedData.fixedCosts || [];
                  goals = importedData.goals || [];
                  categories = importedData.categories || [];
                  accounts = importedData.accounts || [];

                  saveData(); // Alle importierten Daten im LocalStorage speichern

                  // Alle UI-Elemente neu laden, um die √Ñnderungen anzuzeigen
                  updateDisplay();
                  updateFixedCostsUI();
                  displayGoals();
                  displayCategories();
                  displayAccounts();
                  updateOverviewStats(document.getElementById("overviewFilterAccount").value); // Wichtig: Aktuellen Filter ber√ºcksichtigen
                  renderCharts();
                  alert("Daten erfolgreich importiert!");
              } catch (error) {
                  console.error("Fehler beim Importieren der Daten:", error);
                  alert("Fehler beim Importieren der Daten. Bitte stellen Sie sicher, dass es sich um eine g√ºltige JSON-Backup-Datei handelt.");
              } finally {
                  // Dateieingabe zur√ºcksetzen, damit die gleiche Datei erneut ausgew√§hlt werden kann
                  event.target.value = '';
              }
          };
          reader.readAsText(file);
      }
            

// Hilfsfunktionen
      function formatCurrency(amount) {
        return new Intl.NumberFormat("de-DE", {
          style: "currency",
          currency: "EUR",
        }).format(amount);
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString("de-DE");
      }

      function saveData() {
        localStorage.setItem("transactions", JSON.stringify(transactions));
        localStorage.setItem("fixedCosts", JSON.stringify(fixedCosts));
        localStorage.setItem("goals", JSON.stringify(goals));
        localStorage.setItem("categories", JSON.stringify(categories));
        localStorage.setItem("accounts", JSON.stringify(accounts));
      }
    </script>
  </body>
</html>
